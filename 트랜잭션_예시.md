# 트랜잭션(Transaction) 설명

## 1. 트랜잭션이 필요한 상황 예시

### 예시: 게시글 작성 시 여러 작업이 필요한 경우

```java
// ❌ 트랜잭션 없이 - 문제가 생길 수 있음
public void createPostWithHistory(String title, String content, String author) {
    // 1. 게시글 저장
    Posts post = Posts.builder()
        .title(title)
        .content(content)
        .author(author)
        .build();
    postsRepository.save(post);
    
    // 2. 작성 이력 저장 (다른 테이블)
    // historyRepository.save(new History("POST_CREATED", author));
    
    // 만약 여기서 에러가 발생하면?
    // → 게시글은 저장되었지만 이력은 저장 안됨 (데이터 불일치!)
}
```

### ✅ 트랜잭션 사용 - 안전함

```java
@Transactional  // 이 메서드는 하나의 트랜잭션으로 실행됨
public void createPostWithHistory(String title, String content, String author) {
    // 1. 게시글 저장
    Posts post = Posts.builder()
        .title(title)
        .content(content)
        .author(author)
        .build();
    postsRepository.save(post);
    
    // 2. 작성 이력 저장
    // historyRepository.save(new History("POST_CREATED", author));
    
    // 만약 여기서 에러가 발생하면?
    // → 모든 작업이 자동으로 취소됨 (롤백)
    // → 게시글도 저장되지 않음 (데이터 일관성 유지!)
}
```

## 2. @Transactional 어노테이션

### 기본 사용법

```java
@Service
public class PostsService {
    
    @Autowired
    private PostsRepository postsRepository;
    
    // ✅ 읽기 전용 트랜잭션 (성능 최적화)
    @Transactional(readOnly = true)
    public Posts findById(Long id) {
        return postsRepository.findById(id)
            .orElseThrow(() -> new IllegalArgumentException("게시글을 찾을 수 없습니다."));
    }
    
    // ✅ 쓰기 트랜잭션 (기본값)
    @Transactional
    public Posts save(String title, String content, String author) {
        Posts post = Posts.builder()
            .title(title)
            .content(content)
            .author(author)
            .build();
        return postsRepository.save(post);
    }
    
    // ✅ 여러 작업을 하나의 트랜잭션으로
    @Transactional
    public void updatePost(Long id, String title, String content) {
        Posts post = postsRepository.findById(id)
            .orElseThrow(() -> new IllegalArgumentException("게시글을 찾을 수 없습니다."));
        
        // 여러 수정 작업...
        // post.setTitle(title);  // 실제로는 setter가 없지만 예시
        // post.setContent(content);
        
        postsRepository.save(post);
    }
}
```

## 3. 트랜잭션의 동작 방식

### 성공 시 (Commit)
```
시작 → 작업1 → 작업2 → 작업3 → 성공 → 커밋 (DB에 저장)
```

### 실패 시 (Rollback)
```
시작 → 작업1 → 작업2 → 에러 발생! → 롤백 (모든 작업 취소)
```

## 4. 현재 프로젝트에서의 트랜잭션

### Repository 메서드는 자동으로 트랜잭션 처리됨
```java
// JpaRepository의 save(), delete() 등은 이미 트랜잭션 처리됨
postsRepository.save(post);  // 자동으로 트랜잭션 안에서 실행
```

### Service 레이어에서 명시적으로 사용
```java
@Service
@Transactional  // 클래스 전체에 트랜잭션 적용
public class PostsService {
    // 모든 메서드가 트랜잭션 안에서 실행됨
}
```

## 5. 트랜잭션 전파 (Propagation)

```java
@Transactional(propagation = Propagation.REQUIRED)  // 기본값
// - 이미 트랜잭션이 있으면 그걸 사용
// - 없으면 새로 생성

@Transactional(propagation = Propagation.REQUIRES_NEW)
// - 항상 새로운 트랜잭션 생성

@Transactional(propagation = Propagation.NEVER)
// - 트랜잭션 없이 실행 (트랜잭션이 있으면 예외 발생)
```

## 6. 실제 사용 예시

### 게시글 삭제 시 관련 데이터도 함께 삭제
```java
@Transactional
public void deletePost(Long id) {
    // 1. 댓글 삭제
    commentRepository.deleteByPostId(id);
    
    // 2. 좋아요 삭제
    likeRepository.deleteByPostId(id);
    
    // 3. 게시글 삭제
    postsRepository.deleteById(id);
    
    // 만약 댓글 삭제는 성공했는데 게시글 삭제가 실패하면?
    // → 모든 작업이 롤백되어 댓글도 삭제되지 않음 (데이터 일관성!)
}
```


